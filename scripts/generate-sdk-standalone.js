#!/usr/bin/env node
/**
 * GHOST PROTOCOL - Générateur SDK sans Orval/Spectral.
 * Lit openapi/base-vitale.json et écrit base-vitale.ts + model (dashboard uniquement).
 * Utilisé quand Orval plante (Spectral/AJV sous Node 20 et 24).
 */
const fs = require('fs');
const path = require('path');

const ROOT = path.resolve(__dirname, '..');
const OPENAPI_PATH = path.join(ROOT, 'openapi/base-vitale.json');
const OUT_CLIENT = path.join(ROOT, 'libs/ghost-sdk/src/lib/generated/base-vitale.ts');
const OUT_MODEL = path.join(ROOT, 'libs/ghost-sdk/src/lib/generated/model/patientDashboard.ts');

const clientContent = `// Generated by scripts/generate-sdk-standalone.js (sans Orval/Spectral).
// GHOST PROTOCOL - SDK BaseVitale. Régénérer avec: npm run openapi:fetch && npm run sdk:gen:file

import type { UseQueryOptions } from '@tanstack/react-query';
import { useQuery } from '@tanstack/react-query';
import type { PatientDashboardStateApiResponse } from './model/patientDashboard';

/** Base URL de l'API (vide = même origine). À surcharger via getBaseUrl(). */
let baseUrl = '';

export function setBaseUrl(url: string): void {
  baseUrl = url.replace(/\\/$/, '');
}

export function getBaseUrl(): string {
  return baseUrl;
}

/** Client HTTP minimal (fetch). */
async function customFetch<T>(
  path: string,
  init?: RequestInit
): Promise<T> {
  const url = path.startsWith('http') ? path : \`\${baseUrl}\${path}\`;
  const res = await fetch(url, {
    ...init,
    headers: {
      'Content-Type': 'application/json',
      ...init?.headers,
    },
  });
  if (!res.ok) {
    const err = new Error(res.statusText || 'API Error');
    (err as any).status = res.status;
    throw err;
  }
  return res.json();
}

// ============== Patient (Dashboard) ==============

/**
 * Récupère l'état agrégé du dashboard patient (Oracle + Security + Coding).
 * GET /api/patient/:id/dashboard-state
 */
export function getPatientDashboardState(id: string): Promise<PatientDashboardStateApiResponse> {
  return customFetch<PatientDashboardStateApiResponse>(\`/api/patient/\${id}/dashboard-state\`);
}

export const getGetPatientDashboardStateQueryKey = (id: string) =>
  ['patient', id, 'dashboard-state'] as const;

/**
 * Hook React Query : état agrégé du dashboard patient (3 piliers).
 * Usage : const { data } = useGetPatientDashboardState(patientId);
 * data?.data contient { oracle, security, coding }.
 */
export function useGetPatientDashboardState(
  id: string,
  options?: Omit<
    UseQueryOptions<PatientDashboardStateApiResponse, Error, PatientDashboardStateApiResponse, ReturnType<typeof getGetPatientDashboardStateQueryKey>>,
    'queryKey' | 'queryFn'
  >
) {
  return useQuery({
    queryKey: getGetPatientDashboardStateQueryKey(id),
    queryFn: () => getPatientDashboardState(id),
    ...options,
  });
}
`;

const modelContent = `// Generated by scripts/generate-sdk-standalone.js (sans Orval/Spectral).

import type {
  PatientDashboardState,
  DashboardOracleState,
  DashboardSecurityState,
  DashboardCodingState,
  CodingSuggestionItem,
} from '@basevitale/shared';

export type {
  PatientDashboardState,
  DashboardOracleState,
  DashboardSecurityState,
  DashboardCodingState,
  CodingSuggestionItem,
};

/** Réponse enveloppée de l'API (TransformInterceptor). */
export interface PatientDashboardStateApiResponse {
  success: boolean;
  data: PatientDashboardState;
  timestamp: string;
}
`;

function main() {
  if (!fs.existsSync(OPENAPI_PATH)) {
    console.error('Erreur: openapi/base-vitale.json introuvable. Lancez d\'abord: npm run openapi:fetch');
    process.exit(1);
  }
  const outDir = path.dirname(OUT_CLIENT);
  const modelDir = path.dirname(OUT_MODEL);
  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });
  if (!fs.existsSync(modelDir)) fs.mkdirSync(modelDir, { recursive: true });
  fs.writeFileSync(OUT_CLIENT, clientContent, 'utf8');
  fs.writeFileSync(OUT_MODEL, modelContent, 'utf8');
  console.log('OK: SDK généré dans libs/ghost-sdk/src/lib/generated/ (standalone, sans Orval)');
}

main();
