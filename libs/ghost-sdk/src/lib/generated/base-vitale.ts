// Generated by scripts/generate-sdk-standalone.js (sans Orval/Spectral).
// GHOST PROTOCOL - SDK BaseVitale. Régénérer avec: npm run openapi:fetch && npm run sdk:gen:file

import type { UseQueryOptions } from '@tanstack/react-query';
import { useQuery } from '@tanstack/react-query';
import type { PatientDashboardStateApiResponse } from './model/patientDashboard';
import type { AnalyzeFullContextResponse, AnalyzeFullContextBody } from './model/orchestratorAnalyze';

/** Base URL de l'API (vide = même origine). À surcharger via getBaseUrl(). */
let baseUrl = '';

export function setBaseUrl(url: string): void {
  baseUrl = url.replace(/\/$/, '');
}

export function getBaseUrl(): string {
  return baseUrl;
}

/** Client HTTP minimal (fetch). */
async function customFetch<T>(
  path: string,
  init?: RequestInit
): Promise<T> {
  const url = path.startsWith('http') ? path : `${baseUrl}${path}`;
  const res = await fetch(url, {
    ...init,
    headers: {
      'Content-Type': 'application/json',
      ...init?.headers,
    },
  });
  if (!res.ok) {
    const err = new Error(res.statusText || 'API Error');
    (err as any).status = res.status;
    throw err;
  }
  return res.json();
}

// ============== Orchestrator (Fusion C+ et B+) ==============

/**
 * Analyse complète : Gardien (C+) + Stratège (B+) en parallèle.
 * POST /api/orchestrator/analyze
 * Déballage de l'enveloppe { success, data, timestamp } côté API.
 */
export async function analyzeFullContext(
  body: AnalyzeFullContextBody = {}
): Promise<AnalyzeFullContextResponse> {
  const raw = await customFetch<{ success?: boolean; data?: AnalyzeFullContextResponse }>(
    '/api/orchestrator/analyze',
    { method: 'POST', body: JSON.stringify(body) }
  );
  return raw?.data ?? (raw as unknown as AnalyzeFullContextResponse);
}

// ============== Patient (Dashboard) ==============

/**
 * Récupère l'état agrégé du dashboard patient (Oracle + Security + Coding).
 * GET /api/patient/:id/dashboard-state
 */
export function getPatientDashboardState(id: string): Promise<PatientDashboardStateApiResponse> {
  return customFetch<PatientDashboardStateApiResponse>(`/api/patient/${id}/dashboard-state`);
}

export const getGetPatientDashboardStateQueryKey = (id: string) =>
  ['patient', id, 'dashboard-state'] as const;

/**
 * Hook React Query : état agrégé du dashboard patient (3 piliers).
 * Usage : const { data } = useGetPatientDashboardState(patientId);
 * data?.data contient { oracle, security, coding }.
 */
export function useGetPatientDashboardState(
  id: string,
  options?: Omit<
    UseQueryOptions<PatientDashboardStateApiResponse, Error, PatientDashboardStateApiResponse, ReturnType<typeof getGetPatientDashboardStateQueryKey>>,
    'queryKey' | 'queryFn'
  >
) {
  return useQuery({
    queryKey: getGetPatientDashboardStateQueryKey(id),
    queryFn: () => getPatientDashboardState(id),
    ...options,
  });
}
